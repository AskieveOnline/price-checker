<!DOCTYPE html>
<html>
<head>
    <title>Price Finder</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .search-container { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 12px 24px; background: #4285F4; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #result { margin-top: 20px; min-height: 100px; padding: 15px; border-radius: 4px; }
        .price { font-size: 24px; color: #1a73e8; font-weight: bold; }
        .error { color: #d93025; background-color: #fce8e6; padding: 10px; }
        .loading { color: #5f6368; }
        .debug { background: #f1f3f4; padding: 15px; margin-top: 20px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Lowest Price Finder</h1>
    <div class="search-container">
        <input type="text" id="product" placeholder="Enter product name...">
        <button onclick="searchPrice()">Search</button>
    </div>
    <div id="result"></div>
    <div id="debug" class="debug" style="display: none;"></div>
    <button onclick="toggleDebug()" style="margin-top: 10px;">Toggle Debug</button>

    <script>
        // Configuration
        const API_KEY = "a4ee6156c39a100b5d4fb2727240e9f9"; // Keep the quotes!
        const TIMEOUT = 45000; // 45 seconds timeout
        
        // DOM Elements
        const resultDiv = document.getElementById("result");
        const debugDiv = document.getElementById("debug");
        let debugMode = false;
        
        async function searchPrice() {
            const product = document.getElementById("product").value.trim();
            if (!product) {
                showError("Please enter a product name");
                return;
            }
            
            resultDiv.innerHTML = '<div class="loading">Searching Google Shopping...</div>';
            debugLog(`Starting search for: "${product}"`);
            
            try {
                const apiUrl = `https://api.scraperapi.com/?api_key=${API_KEY}&render=true&url=https://www.google.com/search?q=${encodeURIComponent(product)}&tbm=shop`;
                
                debugLog("Fetching URL:", apiUrl);
                const response = await fetchWithTimeout(apiUrl, TIMEOUT);
                
                if (!response.ok) {
                    throw new Error(`API returned status: ${response.status}`);
                }
                
                const html = await response.text();
                debugLog("Received HTML (truncated):", html.substring(0, 500) + "...");
                
                const prices = extractPrices(html);
                if (prices.length === 0) {
                    showError("No prices found in the response. Google may have blocked the request.");
                    debugLog("Full HTML for debugging:", html);
                    return;
                }
                
                displayResult(prices);
                
            } catch (error) {
                console.error("Search failed:", error);
                showError(`Error: ${error.message}`);
                debugLog("Error details:", error);
            }
        }
        
        function extractPrices(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const priceElements = doc.querySelectorAll(".tAxDx, .a8Pemb, .TL92Hc, .g9WBQb, .HRLxBb");
            
            const prices = [];
            priceElements.forEach(el => {
                const priceText = el.textContent.trim();
                const priceValue = parseFloat(priceText.replace(/[^\d.]/g, ""));
                if (!isNaN(priceValue)) {
                    prices.push({
                        value: priceValue,
                        element: el.outerHTML
                    });
                }
            });
            
            return prices.sort((a, b) => a.value - b.value);
        }
        
        function displayResult(prices) {
            const lowest = prices[0];
            resultDiv.innerHTML = `
                <div class="price">$${lowest.value.toFixed(2)}</div>
                <div>Found ${prices.length} prices | ${new Date().toLocaleTimeString()}</div>
                ${debugMode ? `<div class="debug">Lowest price element: ${lowest.element}</div>` : ''}
            `;
        }
        
        function showError(message) {
            resultDiv.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function debugLog(...messages) {
            if (!debugMode) return;
            debugDiv.textContent += messages.map(msg => 
                typeof msg === 'object' ? JSON.stringify(msg, null, 2) : msg
            ).join(' ') + '\n\n';
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            debugDiv.style.display = debugMode ? 'block' : 'none';
        }
        
        async function fetchWithTimeout(url, timeout) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0'
                    }
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`Request timed out after ${timeout/1000} seconds`);
                }
                throw error;
            }
        }
    </script>
</body>
</html>
