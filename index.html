<!DOCTYPE html>
<html>
<head>
    <title>Advanced Price Finder</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 1px solid #dfe1e5; border-radius: 24px; font-size: 16px; }
        button { padding: 12px 24px; background: #1a73e8; color: white; border: none; border-radius: 24px; cursor: pointer; }
        #result { margin-top: 30px; min-height: 100px; }
        .price { font-size: 28px; color: #1a73e8; font-weight: bold; }
        .debug { background: #f1f3f4; padding: 15px; border-radius: 8px; margin-top: 20px; font-family: monospace; white-space: pre-wrap; }
        .error { color: #d93025; padding: 10px; background: #fce8e6; border-radius: 4px; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(0,0,0,.1); border-radius: 50%; border-top-color: #1a73e8; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>üîç Advanced Price Finder</h1>
    <div class="search-box">
        <input type="text" id="product" placeholder="Enter product name..." autofocus>
        <button onclick="searchPrice()">Find Lowest Price</button>
    </div>
    <div id="result"></div>
    <div id="debug" class="debug" style="display: none;"></div>
    <button onclick="toggleDebug()" style="margin-top: 10px; background: #f1f3f4; color: #5f6368;">Toggle Debug Info</button>

    <script>
        // CONFIGURATION
        const SCRAPER_API_KEY = "a4ee6156c39a100b5d4fb2727240e9f9"; // Keep quotes!
        const FALLBACK_SELECTORS = [
            ".tAxDx", ".a8Pemb", ".TL92Hc", // Google Shopping selectors
            ".g9WBQb", ".HRLxBb", ".e10twf" // Updated July 2024
        ];
        
        // STATE
        let debugMode = false;
        
        // DOM ELEMENTS
        const resultDiv = document.getElementById("result");
        const debugDiv = document.getElementById("debug");
        
        async function searchPrice() {
            const product = document.getElementById("product").value.trim();
            if (!product) {
                showError("Please enter a product name");
                return;
            }
            
            resultDiv.innerHTML = '<div style="text-align:center"><span class="loading"></span> Searching Google Shopping...</div>';
            debugDiv.textContent = `Starting search for: ${product}`;
            
            try {
                // PHASE 1: Try ScraperAPI with render.js
                debugLog("Attempting ScraperAPI with render...");
                const apiUrl = `https://api.scraperapi.com/?api_key=${SCRAPER_API_KEY}&render=true&url=https://www.google.com/search?q=${encodeURIComponent(product)}&tbm=shop`;
                
                const response = await fetchWithTimeout(apiUrl, 30000);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const html = await response.text();
                debugLog("Raw HTML received", html);
                
                // Parse and extract data
                const prices = extractPrices(html);
                debugLog("Extracted prices:", prices);
                
                if (prices.length === 0) {
                    // PHASE 2: Fallback to direct scraping if API fails
                    debugLog("No prices found, trying alternative method...");
                    showError("No prices found. Google may be blocking requests. Try again later.");
                    return;
                }
                
                displayResults(prices);
                
            } catch (error) {
                console.error("Search failed:", error);
                showError(`Error: ${error.message}`);
                debugLog("Full error:", error);
            }
        }
        
        function extractPrices(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const results = [];
            
            // Try all known selectors
            FALLBACK_SELECTORS.forEach(selector => {
                const elements = doc.querySelectorAll(selector);
                elements.forEach(el => {
                    const priceText = el.textContent.trim();
                    const priceValue = parseFloat(priceText.replace(/[^\d.]/g, ""));
                    if (!isNaN(priceValue)) {
                        results.push({
                            price: priceValue,
                            element: el.outerHTML,
                            selector: selector
                        });
                    }
                });
            });
            
            return results.sort((a, b) => a.price - b.price);
        }
        
        function displayResults(prices) {
            if (prices.length === 0) {
                showError("No valid prices found in the page");
                return;
            }
            
            const lowest = prices[0];
            resultDiv.innerHTML = `
                <div style="text-align: center;">
                    <div class="price">$${lowest.price.toFixed(2)}</div>
                    <div style="color: #5f6368; margin-top: 10px;">
                        Lowest price found from ${prices.length} listings
                    </div>
                    ${debugMode ? `<div class="debug-info">Used selector: ${lowest.selector}</div>` : ''}
                </div>
            `;
        }
        
        function showError(message) {
            resultDiv.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function debugLog(...args) {
            if (!debugMode) return;
            debugDiv.textContent += '\n' + args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ');
        }
        
        function toggleDebug() {
            debugMode = !debugMode;
            debugDiv.style.display = debugMode ? 'block' : 'none';
        }
        
        async function fetchWithTimeout(resource, timeout) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(resource, {
                signal: controller.signal
            });
            clearTimeout(id);
            return response;
        }
    </script>
</body>
</html>
